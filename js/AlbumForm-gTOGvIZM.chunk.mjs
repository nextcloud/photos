import{A as r,E as b,Q as p,e as n,f as s,R as i,r as h,S as m,o as d}from"./index-B_-Mz_Iy.chunk.mjs";import{E as C,s as y,t as f,A as k,i as g,n as c,u as v,v as L,M as _}from"./icons-CCMXs15V.chunk.mjs";import{t as u,G as N,_ as S,g as w,a6 as A}from"./vue.runtime.esm-K-L1yEsQ.chunk.mjs";import{m as x}from"./index-D-GU54Qs.chunk.mjs";import{S as e}from"./index-BycAmYAy.chunk.mjs";import{F}from"./FetchCollectionContentMixin-CvMc_LbU.chunk.mjs";const M="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20id='mdi-account-group'%20viewBox='0%200%2024%2024'%3e%3cpath%20d='M12,5.5A3.5,3.5%200%200,1%2015.5,9A3.5,3.5%200%200,1%2012,12.5A3.5,3.5%200%200,1%208.5,9A3.5,3.5%200%200,1%2012,5.5M5,8C5.56,8%206.08,8.15%206.53,8.42C6.38,9.85%206.8,11.27%207.66,12.38C7.16,13.34%206.16,14%205,14A3,3%200%200,1%202,11A3,3%200%200,1%205,8M19,8A3,3%200%200,1%2022,11A3,3%200%200,1%2019,14C17.84,14%2016.84,13.34%2016.34,12.38C17.2,11.27%2017.62,9.85%2017.47,8.42C17.92,8.15%2018.44,8%2019,8M5.5,18.25C5.5,16.18%208.41,14.5%2012,14.5C15.59,14.5%2018.5,16.18%2018.5,18.25V20H5.5V18.25M0,20V18.5C0,17.11%201.89,15.94%204.45,15.6C3.86,16.28%203.5,17.22%203.5,18.25V20H0M24,20H20.5V18.25C20.5,17.22%2020.14,16.28%2019.55,15.6C22.11,15.94%2024,17.11%2024,18.5V20Z'%20/%3e%3c/svg%3e",B={name:"CollaboratorsSelectionForm",components:{Close:g,AccountGroup:k,ContentCopy:f,Check:y,Earth:C,NcButton:n,NcListItemIcon:p,NcSelect:b},mixins:[F],props:{albumName:{type:String,required:!0},collaborators:{type:Array,default:()=>[]},allowPublicLink:{type:Boolean,default:!0}},data(){return{searchText:null,availableCollaborators:{},selectedCollaboratorsKeys:[],currentSearchResults:[],loadingCollaborators:!1,randomId:Math.random().toString().substring(2,10),publicLinkCopied:!1,collaboratorTypes:e,config:{minSearchStringLength:parseInt(OC.config["sharing.minSearchStringLength"],10)||0}}},computed:{searchResults(){return this.currentSearchResults.filter(({id:t})=>t!==w()?.uid).map(t=>({...t,key:`${t.type}:${t.id}`,iconSvg:t.type===e.Group?M:void 0})).filter(({key:t})=>!this.selectedCollaboratorsKeys.includes(t))},listableSelectedCollaboratorsKeys(){return this.selectedCollaboratorsKeys.filter(t=>this.availableCollaborators[t].type!==e.Link)},selectedCollaborators(){return this.selectedCollaboratorsKeys.map(t=>this.availableCollaborators[t])},isPublicLinkSelected(){return this.selectedCollaboratorsKeys.includes(`${e.Link}`)},publicLink(){return this.availableCollaborators[e.Link]},publicLinkURL(){return`${window.location.protocol}//${window.location.host}${S(`apps/photos/public/${this.publicLink.id}`)}`},albumFileName(){return this.$store.getters.getAlbumName(this.albumName)}},watch:{collaborators(t){this.populateCollaborators(t)}},mounted(){this.populateCollaborators(this.collaborators)},methods:{...r(["updateCollection"]),async searchCollaborators(t){if(t!==void 0&&(t=t.trim(),!(t.length<this.config.minSearchStringLength)))try{this.loadingCollaborators=!0;const a=await h.get(N("core/autocomplete/get"),{params:{search:t,itemType:"share-recipients",shareTypes:[e.User,e.Group]}});this.currentSearchResults=a.data.ocs.data.map(o=>{switch(o.source){case"users":return{id:o.id,label:o.label,type:e.User};case"groups":return{id:o.id,label:o.label,type:e.Group};default:throw new Error(`Invalid collaborator source ${o.source}`)}}),this.availableCollaborators={...this.availableCollaborators,...this.currentSearchResults.reduce(this.indexCollaborators,{})}}catch(a){this.errorFetchingCollaborators=a,s.error(this.t("photos","Failed to fetch collaborators list."),{error:a}),i(this.t("photos","Failed to fetch collaborators list."))}finally{this.loadingCollaborators=!1}},populateCollaborators(t){const a=t.reduce(this.indexCollaborators,{});this.selectedCollaboratorsKeys=Object.keys(a),this.availableCollaborators={3:{id:"",label:this.t("photos","Public link"),type:e.Link},...this.availableCollaborators,...a}},indexCollaborators(t,a){return{...t,[`${a.type}${a.type===e.Link?"":":"}${a.type===e.Link?"":a.id}`]:a}},async createPublicLinkForAlbum(){this.selectEntity(`${e.Link}`),await this.updateAlbumCollaborators(),await this.fetchCollection(this.albumFileName,["<nc:location />","<nc:dateRange />","<nc:collaborators />"])},async deletePublicLink(){this.unselectEntity(`${e.Link}`),this.availableCollaborators[3]={id:"",label:this.t("photos","Public link"),type:e.Link},this.publicLinkCopied=!1,await this.updateAlbumCollaborators()},async updateAlbumCollaborators(){try{await this.updateCollection({collectionFileName:this.albumFileName,properties:{collaborators:this.selectedCollaborators}})}catch(t){s.error("[PublicAlbumContent] Error updating album",{error:t}),i(this.t("photos","Failed to update album."))}},async copyPublicLink(){await navigator.clipboard.writeText(this.publicLinkURL),this.publicLinkCopied=!0,setTimeout(()=>{this.publicLinkCopied=!1},1e4)},selectEntity(t){this.searchText=null,!this.selectedCollaboratorsKeys.includes(t)&&this.selectedCollaboratorsKeys.push(t)},unselectEntity(t){const a=this.selectedCollaboratorsKeys.indexOf(t);a!==-1&&this.selectedCollaboratorsKeys.splice(a,1)},t:u}};var $=function(){var t=this,a=t._self._c;return a("div",{staticClass:"manage-collaborators"},[a("h2",{staticClass:"manage-collaborators__title"},[t._v(" "+t._s(t.t("photos","Add collaborators"))+" ")]),a("form",{staticClass:"manage-collaborators__form",on:{submit:function(o){o.preventDefault()}}},[a("NcSelect",{attrs:{"input-id":"sharing-search-input","input-label":t.t("photos","Add people or groups who can edit your album"),loading:t.loadingCollaborators,label:"label",filterable:!1,placeholder:t.t("photos","Search people or groups"),"clear-search-on-blur":()=>!1,"user-select":!0,"append-to-body":!1,options:t.searchResults},on:{search:t.searchCollaborators,"option:selected":({key:o})=>t.selectEntity(o)},model:{value:t.searchText,callback:function(o){t.searchText=o},expression:"searchText"}},[t._v(" "+t._s(t.t("photos","No recommendations. Start typing."))+" ")])],1),a("ul",{staticClass:"manage-collaborators__selection"},t._l(t.listableSelectedCollaboratorsKeys,function(o){return a("li",{key:o,staticClass:"manage-collaborators__selection__item"},[a("NcListItemIcon",{attrs:{id:t.availableCollaborators[o].id,"display-name":t.availableCollaborators[o].label,name:t.availableCollaborators[o].label,user:t.availableCollaborators[o].id,"is-no-user":t.availableCollaborators[o].type!==t.collaboratorTypes.User}},[t.availableCollaborators[o].type===t.collaboratorTypes.Group?a("AccountGroup",{attrs:{title:t.t("photos","Group")}}):t._e(),a("NcButton",{attrs:{type:"tertiary","aria-label":t.t("photos","Remove {collaboratorLabel} from the collaborators list",{collaboratorLabel:t.availableCollaborators[o].label})},on:{click:function(l){return t.unselectEntity(o)}}},[a("Close",{attrs:{slot:"icon",size:20},slot:"icon"})],1)],1)],1)}),0),a("div",{staticClass:"actions"},[t.allowPublicLink?a("div",{staticClass:"actions__public-link"},[t.isPublicLinkSelected&&t.publicLink.id!==""?[a("NcButton",{staticClass:"manage-collaborators__public-link-button",attrs:{"aria-label":t.t("photos","Copy the public link"),title:t.publicLinkURL},on:{click:t.copyPublicLink},scopedSlots:t._u([{key:"icon",fn:function(){return[t.publicLinkCopied?a("Check"):a("ContentCopy")]},proxy:!0}],null,!1,845538853)},[t.publicLinkCopied?[t._v(" "+t._s(t.t("photos","Public link copied!"))+" ")]:[t._v(" "+t._s(t.t("photos","Copy public link"))+" ")]],2),a("NcButton",{attrs:{type:"tertiary","aria-label":t.t("photos","Delete the public link")},on:{click:t.deletePublicLink}},[a("Close",{attrs:{slot:"icon"},slot:"icon"})],1)]:a("NcButton",{staticClass:"manage-collaborators__public-link-button",attrs:{disabled:t.isPublicLinkSelected&&t.publicLink.id==="","aria-label":t.t("photos","Create public link share")},on:{click:t.createPublicLinkForAlbum}},[a("Earth",{attrs:{slot:"icon"},slot:"icon"}),t._v(" "+t._s(t.t("photos","Share via public link"))+" ")],1)],2):t._e(),a("div",{staticClass:"actions__slot"},[t._t("default",null,{collaborators:t.selectedCollaborators})],2)])])},P=[],T=c(B,$,P,!1,null,"13596046");const E=T.exports,I={name:"AlbumForm",components:{MapMarker:_,AccountMultiplePlus:L,Send:v,NcButton:n,NcLoadingIcon:d,NcTextField:m,CollaboratorsSelectionForm:E},props:{album:{type:Object,default:null},displayBackButton:{type:Boolean,default:!1}},data(){return{showCollaboratorView:!1,albumName:"",albumLocation:"",loading:!1}},computed:{editMode(){return this.album!==null},sharingEnabled(){return OC.Share!==void 0},albumFileName(){return this.$store.getters.getAlbumName(this.albumName)}},mounted(){this.editMode&&(this.albumName=this.album.basename,this.albumLocation=this.album.location??""),this.$nextTick(()=>{this.$refs.nameInput.$el.getElementsByTagName("input")[0].focus()})},methods:{...r(["createCollection","renameCollection","updateCollection"]),submit(t=[]){this.albumName===""||this.loading||(this.editMode?this.handleUpdateAlbum():this.handleCreateAlbum(t))},async handleCreateAlbum(t=[]){try{this.loading=!0;let a=await this.createCollection({collection:{basename:this.albumName,filename:this.albumFileName,nbItems:0,location:this.albumLocation,lastPhoto:-1,date:x().format("MMMM YYYY"),collaborators:t,source:A(`dav/${this.albumFileName}`)}});if(a===void 0)return;(this.albumLocation!==""||t.length!==0)&&(a=await this.updateCollection({collectionFileName:this.albumFileName,properties:{location:this.albumLocation,collaborators:t}})),this.$emit("done",{album:a})}finally{this.loading=!1}},async handleUpdateAlbum(){try{this.loading=!0;let t={...this.album};this.album.basename!==this.albumName&&(t=await this.renameCollection({collectionFileName:this.album.filename,newBaseName:this.albumName})),this.album.location!==this.albumLocation&&(t=await this.updateCollection({collectionFileName:t.filename,properties:{location:this.albumLocation}})),this.$emit("done",{album:t})}finally{this.loading=!1}},back(){this.$emit("back")},t:u}};var R=function(){var t=this,a=t._self._c;return t.showCollaboratorView?a("CollaboratorsSelectionForm",{attrs:{"album-name":t.albumName,"allow-public-link":!1},scopedSlots:t._u([{key:"default",fn:function({collaborators:o}){return[a("span",{staticClass:"left-buttons"},[a("NcButton",{attrs:{type:"tertiary"},on:{click:function(l){t.showCollaboratorView=!1}}},[t._v(" "+t._s(t.t("photos","Back"))+" ")])],1),a("span",{staticClass:"right-buttons"},[a("NcButton",{attrs:{type:"primary",disabled:t.albumName.trim()===""||t.loading},on:{click:function(l){return t.submit(o)}},scopedSlots:t._u([{key:"icon",fn:function(){return[t.loading?a("NcLoadingIcon",{attrs:{size:20}}):a("Send",{attrs:{size:20}})]},proxy:!0}],null,!0)},[t._v(" "+t._s(t.editMode?t.t("photos","Save"):t.t("photos","Create album"))+" ")])],1)]}}])}):a("form",{staticClass:"album-form",on:{submit:function(o){return o.preventDefault(),t.submit.apply(null,arguments)}}},[a("div",{staticClass:"form-inputs"},[a("NcTextField",{ref:"nameInput",attrs:{value:t.albumName,type:"text",name:"name",required:!0,label:t.t("photos","Name of the album")},on:{"update:value":function(o){t.albumName=o}}}),a("NcTextField",{attrs:{value:t.albumLocation,name:"location",type:"text",label:t.t("photos","Location of the album")},on:{"update:value":function(o){t.albumLocation=o}},scopedSlots:t._u([{key:"default",fn:function(){return[a("MapMarker",{attrs:{size:20}})]},proxy:!0}],null,!1,2964444886)})],1),a("div",{staticClass:"form-buttons"},[a("span",{staticClass:"left-buttons"},[t.displayBackButton?a("NcButton",{attrs:{type:"tertiary"},on:{click:t.back}},[t._v(" "+t._s(t.t("photos","Back"))+" ")]):t._e()],1),a("span",{staticClass:"right-buttons"},[t.sharingEnabled&&!t.editMode?a("NcButton",{attrs:{type:"secondary",disabled:t.albumName.trim()===""||t.loading},on:{click:function(o){t.showCollaboratorView=!0}},scopedSlots:t._u([{key:"icon",fn:function(){return[a("AccountMultiplePlus",{attrs:{size:20}})]},proxy:!0}],null,!1,3656768963)},[t._v(" "+t._s(t.t("photos","Add collaborators"))+" ")]):t._e(),a("NcButton",{attrs:{type:"primary",disabled:t.albumName===""||t.loading},on:{click:function(o){return t.submit()}},scopedSlots:t._u([{key:"icon",fn:function(){return[t.loading?a("NcLoadingIcon",{attrs:{size:20}}):a("Send",{attrs:{size:20}})]},proxy:!0}],null,!1,2302891232)},[t._v(" "+t._s(t.editMode?t.t("photos","Save"):t.t("photos","Create album"))+" ")])],1)])])},K=[],V=c(I,R,K,!1,null,"29b03159");const H=V.exports;export{H as A,E as C};
//# sourceMappingURL=AlbumForm-gTOGvIZM.chunk.mjs.map

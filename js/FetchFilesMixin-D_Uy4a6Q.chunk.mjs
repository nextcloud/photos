import{d as g,b as m,a as d}from"./vue.runtime.esm-OiydnxB-.chunk.mjs";import{l,p as b,d as y,j as w,s as O,S as v}from"./index-ycziVi-9.chunk.mjs";import{g as S}from"./PhotoSearch-D9pXMTwk.chunk.mjs";import{A as j}from"./AbortControllerMixin-BH-eXynx.chunk.mjs";var I=Object.defineProperty,x=Object.defineProperties,P=Object.getOwnPropertyDescriptors,F=Object.getOwnPropertySymbols,R=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable,f=(i,e,t)=>e in i?I(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,D=(i,e)=>{for(var t in e||(e={}))R.call(e,t)&&f(i,t,e[t]);if(F)for(var t of F(e))E.call(e,t)&&f(i,t,e[t]);return i},M=(i,e)=>x(i,P(e));const _=g({name:"FetchFilesMixin",mixins:[j],data(){return{errorFetchingFiles:null,loadingFiles:!1,doneFetchingFiles:!1,fetchSemaphore:new v(1),fetchedFileIds:[]}},watch:{"$route.path":function(){this.resetFetchFilesState()}},methods:{async fetchFiles(i={},e,t=!1){var a,c,h;if(this.doneFetchingFiles&&!t||this.loadingFiles)return[];const p=this.abortController.signal,u=await this.fetchSemaphore.acquire();try{this.errorFetchingFiles=null,this.loadingFiles=!0;const s=200;let o=await S(M(D({firstResult:this.fetchedFileIds.length,nbResults:s},i),{signal:p}));o.length!==s&&(this.doneFetchingFiles=!0),e!==void 0&&(o=o.filter(e));const r=o.map(n=>n.fileid).filter(n=>!this.fetchedFileIds.includes(n));return this.fetchedFileIds.push(...r),this.$store.dispatch("appendFiles",o),l.debug("[FetchFilesMixin] Fetched ".concat(r.length," new files: "),{fileIds:r}),r}catch(s){if(((a=s.response)==null?void 0:a.status)===404){const o=b.state.userConfig.photosSourceFolders;for(const r of o)if(((h=(c=s.response)==null?void 0:c.data)==null?void 0:h.match("File with name /".concat(r," could not be located")))!==null){l.debug("The ".concat(r," folder does not exist, creating it."));try{return await y.createDirectory(w(m,r)),this.resetFetchFilesState(),[]}catch(n){this.errorFetchingFiles=404,l.error("Fail to create source directory",{error:n})}}}else{if(s instanceof DOMException&&s.code===s.ABORT_ERR)return[];this.errorFetchingFiles=s}O(d("photos","Error fetching files")),l.error(d("photos","Error fetching files"),{error:s})}finally{this.loadingFiles=!1,this.fetchSemaphore.release(u)}return[]},resetFetchFilesState(){this.abortPendingRequest(),this.doneFetchingFiles=!1,this.errorFetchingFiles=null,this.loadingFiles=!1,this.fetchedFileIds=[]}}});export{_ as F};
//# sourceMappingURL=FetchFilesMixin-D_Uy4a6Q.chunk.mjs.map

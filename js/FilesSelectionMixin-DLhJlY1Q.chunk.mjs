import{u as y,s as b,d as T}from"./vue.runtime.esm-OiydnxB-.chunk.mjs";import{N as k}from"./NcEmptyContent-RnRTX9Z0.chunk.mjs";import{l as d,w as j}from"./index-ycziVi-9.chunk.mjs";import{n as f,u as F}from"./icons-UgBTm9C1.chunk.mjs";import{f as L}from"./fileFetcher-BYWMW9gM.chunk.mjs";const z={};var E=function(e,t){return e("ul",t._l(t.props.rows,function(i){return e("div",{key:i.key,staticClass:"tiled-row",style:{height:"".concat(i.height,"px")}},t._l(i.items,function(o){return e("li",{key:o.id,style:{width:o.ratio?"".concat(i.height*o.ratio,"px"):"100%",height:"".concat(i.height,"px")}},[t._t("default",null,{row:i,item:o})],2)}),0)}),0)},I=[],$=f(z,E,I,!0,null,"c003b6e3");const x=$.exports;var M=Object.defineProperty,N=Object.defineProperties,B=Object.getOwnPropertyDescriptors,w=Object.getOwnPropertySymbols,D=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable,v=(e,t,i)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,V=(e,t)=>{for(var i in t||(t={}))D.call(t,i)&&v(e,i,t[i]);if(w)for(var i of w(t))W.call(t,i)&&v(e,i,t[i]);return e},R=(e,t)=>N(e,B(t));function K(e,t,i=200){if(t===0)return[];const o=[];let r=0,n=0;for(;n<e.length;){const l=[];do l.push(e[n++]);while(n<e.length&&A([...l,e[n]],i)<=t);const a=U(l,t,e.length===n,i);o[r]={items:l.map(h=>R(V({},h),{width:a*h.ratio,height:a})),height:a,key:l.map(h=>h.id).join("-")},r+=1}return o}function A(e,t){return e.map(i=>t*i.ratio).reduce((i,o)=>i+o)}function U(e,t,i,o){const r=e.map(l=>l.ratio).reduce((l,a)=>l+a);let n=t/r;return e.length===1&&e[0].width>t&&(n=t/e[0].ratio),i&&(n=Math.min(o+20,n)),n}var q=Object.defineProperty,Y=Object.defineProperties,G=Object.getOwnPropertyDescriptors,S=Object.getOwnPropertySymbols,J=Object.prototype.hasOwnProperty,Q=Object.prototype.propertyIsEnumerable,O=(e,t,i)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,H=(e,t)=>{for(var i in t||(t={}))J.call(t,i)&&O(e,i,t[i]);if(S)for(var i of S(t))Q.call(t,i)&&O(e,i,t[i]);return e},_=(e,t)=>Y(e,G(t));const X={name:"TiledLayout",components:{TiledRows:x},props:{sections:{type:Array,required:!0},baseHeight:{type:Number,default:200}},data(){return{containerWidth:0,resizeObserver:null}},computed:{tiledSections(){return d.debug("[TiledLayout] Computing rows",{items:this.sections}),this.sections.map(e=>{const t=K(e.items,this.containerWidth,this.baseHeight);return _(H({},e),{key:e.id,rows:t.map(i=>_(H({},i),{sectionKey:e.id})),height:t.reduce((i,o)=>i+o.height,0)})})}},mounted(){this.resizeObserver=new ResizeObserver(e=>{for(const t of e){const i=t.contentRect;t.target.classList.contains("tiled-container")&&(this.containerWidth=i.width)}}),this.resizeObserver.observe(this.$refs.tiledLayoutContainer)},beforeDestroy(){var e;(e=this.resizeObserver)==null||e.disconnect()}};var Z=function(){var e=this,t=e._self._c;return t("div",{ref:"tiledLayoutContainer",staticClass:"tiled-container"},[e._t("default",function(){return[t("TiledRows",{attrs:{rows:e.tiledSections}})]},{tiledSections:e.tiledSections})],2)},ee=[],te=f(X,Z,ee,!1,null,"5c61fbb5");const ie=te.exports;var se=Object.defineProperty,oe=Object.defineProperties,re=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,ne=Object.prototype.hasOwnProperty,le=Object.prototype.propertyIsEnumerable,P=(e,t,i)=>t in e?se(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,m=(e,t)=>{for(var i in t||(t={}))ne.call(t,i)&&P(e,i,t[i]);if(C)for(var i of C(t))le.call(t,i)&&P(e,i,t[i]);return e},g=(e,t)=>oe(e,re(t));const ae={name:"VirtualScrolling",props:{sections:{type:Array,required:!0},containerElement:{type:HTMLElement,default:null},useWindow:{type:Boolean,default:!1},headerHeight:{type:Number,default:75},renderDistance:{type:Number,default:.5},bottomBufferRatio:{type:Number,default:2},scrollToKey:{type:String,default:""}},data(){return{scrollPosition:0,containerHeight:0,rowsContainerHeight:0,resizeObserver:null}},computed:{visibleSections(){d.debug("[VirtualScrolling] Computing visible section",{sections:this.sections});const e=this.containerHeight,t=this.scrollPosition,i=t+e;let o=0,r=0;const n=this.sections.map(s=>(r+=this.headerHeight,g(m({},s),{rows:s.rows.reduce((c,u)=>{o=r,r+=u.height;let p=0;return r<t?p=(t-r)/e:o>i&&(p=(o-i)/e),p>this.renderDistance?c:[...c,g(m({},u),{distance:p})]},[])}))).filter(s=>s.rows.length>0),l=n.flatMap(({rows:s})=>s).flatMap(({items:s})=>s);l.forEach(s=>s.key=this.rowIdToKeyMap[s.id]);const a=l.map(({key:s})=>s).filter(s=>s!==void 0),h=Object.values(this.rowIdToKeyMap).filter(s=>!a.includes(s));return l.filter(({key:s})=>s===void 0).forEach(s=>{var c;return s.key=(c=h.pop())!=null?c:Math.random().toString(36).substr(2)}),this.rowIdToKeyMap=l.reduce((s,{id:c,key:u})=>g(m({},s),{["".concat(c)]:u}),{}),n},totalHeight(){return this.sections.map(e=>this.headerHeight+e.height).reduce((e,t)=>e+t,0)+200},paddingTop(){if(this.visibleSections.length===0)return 0;let e=0;for(const t of this.sections){if(t.key!==this.visibleSections[0].rows[0].sectionKey){e+=this.headerHeight+t.height;continue}for(const i of t.rows){if(i.key===this.visibleSections[0].rows[0].key)return e;e+=i.height}e+=this.headerHeight}return e},rowsContainerStyle(){return{height:"".concat(this.totalHeight,"px"),paddingTop:"".concat(this.paddingTop,"px")}},isNearBottom(){const e=this.containerHeight*this.bottomBufferRatio;return this.scrollPosition+this.containerHeight>=this.totalHeight-e},container(){return d.debug("[VirtualScrolling] Computing container"),this.containerElement!==null?this.containerElement:this.useWindow?window:this.$refs.container}},watch:{isNearBottom(e){d.debug("[VirtualScrolling] isNearBottom changed",{value:e}),e&&this.$emit("need-content")},visibleSections(){this.isNearBottom&&this.$emit("need-content")},scrollToKey(e){let t=0;for(const i of this.sections){if(i.key!==e){t+=this.headerHeight+i.height;continue}break}d.debug("[VirtualScrolling] Scrolling to",{currentRowTopDistanceFromTop:t}),this.$refs.container.scrollTo({top:t,behavior:"smooth"})}},beforeCreate(){this.rowIdToKeyMap={}},mounted(){var e;this.resizeObserver=new ResizeObserver(t=>{for(const i of t){const o=i.contentRect;i.target===this.container&&(this.containerHeight=o.height),i.target.classList.contains("vs-rows-container")&&(this.rowsContainerHeight=o.height)}}),this.useWindow?(window.addEventListener("resize",this.updateContainerSize,{passive:!0}),this.containerHeight=window.innerHeight):this.resizeObserver.observe(this.container),this.resizeObserver.observe(this.$refs.rowsContainer),(e=this.container)==null||e.addEventListener("scroll",this.updateScrollPosition,{passive:!0})},beforeDestroy(){var e,t;this.useWindow&&window.removeEventListener("resize",this.updateContainerSize),(e=this.resizeObserver)==null||e.disconnect(),(t=this.container)==null||t.removeEventListener("scroll",this.updateScrollPosition)},methods:{updateScrollPosition(){var e;(e=this._onScrollHandle)!=null||(this._onScrollHandle=requestAnimationFrame(()=>{this._onScrollHandle=null,this.useWindow?this.scrollPosition=this.container.scrollY:this.scrollPosition=this.container.scrollTop}))},updateContainerSize(){this.containerHeight=window.innerHeight}}};var ce=function(){var e=this,t=e._self._c;return!e.useWindow&&e.containerElement===null?t("div",{ref:"container",staticClass:"vs-container"},[t("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)]):t("div",{ref:"rowsContainer",staticClass:"vs-rows-container",style:e.rowsContainerStyle},[e._t("default",null,{visibleSections:e.visibleSections}),e._t("loader")],2)},he=[],de=f(ae,ce,he,!1,null,"cb2732da");const ue=de.exports,pe={name:"FilesListViewer",components:{PackageVariant:F,NcEmptyContent:k,NcLoadingIcon:j,TiledLayout:ie,VirtualScrolling:ue},props:{fileIds:{type:Array,default:void 0},fileIdsBySection:{type:Object,default:void 0},sections:{type:Array,default:void 0},loading:{type:Boolean,default:!1},emptyMessage:{type:String,default:""},baseHeight:{type:Number,default:200},sectionHeaderHeight:{type:Number,default:75},scrollToSection:{type:String,default:""},containerElement:{type:[HTMLElement,null],default:null},useWindow:{type:Boolean,default:!1}},data(){return{placeholderFiles:Array(20).fill(0).map((e,t)=>{const i=this.croppedLayout?200:200*(1+Math.random()*2);return{id:t.toString(),width:i,height:200,ratio:i/200}})}},computed:{files(){return this.$store.state.files.files},showPlaceholders(){var e,t;return this.loading&&(((e=this.fileIds)==null?void 0:e.length)===0||((t=this.sections)==null?void 0:t.length)===0)},itemsBySections(){return this.fileIds!==void 0?this.showPlaceholders?[{id:"",items:this.placeholderFiles}]:[{id:"",items:this.fileIds.filter(e=>this.files[e]).map(this.mapFileToItem)}]:this.sections!==void 0?this.showPlaceholders?[{id:"placeholder",items:this.placeholderFiles}]:this.sections.map(e=>({id:e,items:this.fileIdsBySection[e].filter(t=>this.files[t]).map(this.mapFileToItem)})):[]},photosCount(){return this.itemsBySections.map(({items:e})=>e.length).reduce((e,t)=>e+t,0)},showLoader(){var e,t;return this.loading&&(((e=this.fileIds)==null?void 0:e.length)!==0||((t=this.sections)==null?void 0:t.length)!==0)},croppedLayout(){return this.$store.state.userConfig.croppedLayout}},mounted(){b("files:node:updated",this.handleFileUpdated),b("files:node:deleted",this.handleFileDeleted)},destroyed(){y("files:node:updated",this.handleFileUpdated),y("files:node:deleted",this.handleFileDeleted)},methods:{needContent(){this.$emit("need-content")},mapFileToItem(e){var t;const i=this.files[e];return{id:(t=i.fileid)==null?void 0:t.toString(),width:i.attributes["metadata-photos-size"].width,height:i.attributes["metadata-photos-size"].height,ratio:this.croppedLayout?1:i.attributes["metadata-photos-size"].width/i.attributes["metadata-photos-size"].height}},async handleFileUpdated({fileid:e}){const t=await L(this.files[e].path);this.$store.dispatch("appendFiles",[t])},handleFileDeleted({fileid:e}){this.$store.commit("deleteFile",e)}}};var fe=function(){var e=this,t=e._self._c;return t("div",{staticClass:"files-list-viewer"},[e.emptyMessage!==""&&e.photosCount===0&&!e.loading?t("NcEmptyContent",{key:"emptycontent",attrs:{name:e.emptyMessage}},[t("PackageVariant",{attrs:{slot:"icon"},slot:"icon"})],1):e._e(),t("TiledLayout",{attrs:{"base-height":e.baseHeight,sections:e.itemsBySections},scopedSlots:e._u([{key:"default",fn:function({tiledSections:i}){return t("VirtualScrolling",{attrs:{"use-window":e.useWindow,"container-element":e.containerElement,sections:i,"scroll-to-key":e.scrollToSection,"header-height":e.sectionHeaderHeight},on:{"need-content":e.needContent},scopedSlots:e._u([{key:"default",fn:function({visibleSections:o}){return e._l(o,function(r){return t("div",{key:r.id},[r.id!==""?[e.showPlaceholders?t("div",{staticClass:"files-list-viewer__placeholder",style:{"flex-basis":"100%",height:"".concat(e.sectionHeaderHeight,"px")}}):e._t("default",null,{file:{id:r.id},isHeader:!0})]:e._e(),t("ul",[e._l(r.rows,function(n,l){return e._l(n.items,function(a){return t("li",{key:a.key,class:{"last-tiled-rows":l===r.rows.length-1},style:{"flex-basis":"".concat(a.width-1,"px"),height:"".concat(a.height,"px")}},[e.showPlaceholders?t("div",{staticClass:"files-list-viewer__placeholder"}):e._t("default",null,{file:a,distance:n.distance})],2)})})],2)],2)})}}])},[e.loading&&!e.showPlaceholders?t("NcLoadingIcon",{staticClass:"files-list-viewer__loader",attrs:{slot:"loader"},slot:"loader"}):e._e()],1)}}])})],1)},me=[],ge=f(pe,fe,me,!1,null,"0d6cc13a");const Oe=ge.exports,He=T({name:"FilesSelectionMixin",data(){return{selection:{}}},watch:{$route(){this.resetSelection()}},methods:{onFileSelectToggle({id:e,value:t}){this.$set(this.selection,e,t)},onUncheckFiles(e){e.forEach(t=>this.$set(this.selection,t,!1))},resetSelection(){this.selection={}}},computed:{selectedFileIds(){return Object.keys(this.selection).filter(e=>this.selection[e])}}});export{He as F,Oe as a};
//# sourceMappingURL=FilesSelectionMixin-DLhJlY1Q.chunk.mjs.map

import{d as A,i as _,a as h,p as n,k as C,F as w,u as g,s as k}from"./vue.runtime.esm-OiydnxB-.chunk.mjs";import{m as r}from"./index-Dt0wq4bO.chunk.mjs";import{a as v}from"./video-BDfR9rZh.chunk.mjs";import{P as N,u as S,s as B}from"./filters-Bm6FUGKw.chunk.mjs";import{N as P}from"./NcActionButton-1gSJfFUC-DtAb5qOU.chunk.mjs";import{w as x,h as p,v as c,O as M,a as I,x as O,N as L,A as u,P as m}from"./index-ycziVi-9.chunk.mjs";import{N as T}from"./NcEmptyContent-RnRTX9Z0.chunk.mjs";import{I as U,P as f,n as b,A as D,F as Y,e as $,k as E,o as V,D as H}from"./icons-UgBTm9C1.chunk.mjs";import{A as R}from"./ActionFavorite-DJrInpOn.chunk.mjs";import{A as y}from"./AlbumForm-mk5FfiU2.chunk.mjs";import{N as j}from"./NcListItem-DzezqYDz-DVueuKq4.chunk.mjs";import{N as Q}from"./NcUserBubble-CWgceS0Q-D2t5mZph.chunk.mjs";import{F as z}from"./FetchCollectionsMixin-Chf78IYR.chunk.mjs";import{F as q}from"./FileComponent-4EaYtoHz.chunk.mjs";import{F as J,a as G}from"./FilesSelectionMixin-DLhJlY1Q.chunk.mjs";import{H as K}from"./HeaderNavigation-83I_NFFa.chunk.mjs";import{F as W}from"./FetchFilesMixin-D_Uy4a6Q.chunk.mjs";import{F as X}from"./FilesByMonthMixin-CSH-hag_.chunk.mjs";import"./preload-helper-CPULxMJS.chunk.mjs";import"./dialog-CiY8TRVl.chunk.mjs";import"./index-gUDvIMxF.chunk.mjs";import"./PhotosFiltersInput-BXJdN7DC.chunk.mjs";import"./NcSelect-BD9fhCVy-vmNiMZzD.chunk.mjs";import"./NcAvatar-OCD_HmOb-BPLtBYgo.chunk.mjs";import"./useModelMigration-EhAWvqDD-CCVvXBPb.chunk.mjs";import"./NcDateTimePicker-BP2THb4s.chunk.mjs";import"./useFormatDateTime-DCSIXuCx.chunk.mjs";import"./createElementId-DhjFt1I9-D5Zp4M-4.chunk.mjs";import"./NcDialog-Bu9xyU24-In8X1aeg.chunk.mjs";import"./NcDateTime-enXYuwj8-BbRwmIXM.chunk.mjs";import"./collectionFetcher-DAjdzmEV.chunk.mjs";import"./NcTextField-DLlQozKA-Cjumguf1.chunk.mjs";import"./ShareType-suoNfd7y.chunk.mjs";import"./FetchCollectionContentMixin-CEM_4uBO.chunk.mjs";import"./AbortControllerMixin-BH-eXynx.chunk.mjs";import"./NcCheckboxRadioSwitch-Di43R9CE-DU845puP.chunk.mjs";import"./fileFetcher-BYWMW9gM.chunk.mjs";import"./PhotoSearch-D9pXMTwk.chunk.mjs";const Z=A({name:"AlbumPicker",components:{Plus:f,ImageMultipleOutline:U,NcButton:p,NcListItem:j,NcLoadingIcon:x,NcUserBubble:Q,AlbumForm:y},filters:{toCoverUrl(e){return C("/apps/photos/api/v1/preview/".concat(e,"?x=").concat(64,"&y=").concat(64))}},mixins:[z],data(){return{showAlbumCreationForm:!1}},computed:{albums(){return this.$store.getters.albums},sharedAlbums(){return this.$store.getters.sharedAlbums},allAlbums(){return[...Object.values(this.albums),...Object.values(this.sharedAlbums)]}},mounted(){this.fetchAlbumList()},methods:{async fetchAlbumList(){var e,t;await this.fetchCollections("/photos/".concat((e=n())==null?void 0:e.uid,"/albums"),c),await this.fetchCollections("/photos/".concat((t=n())==null?void 0:t.uid,"/sharedalbums"),c)},albumCreatedHandler(){this.showAlbumCreationForm=!1,this.fetchAlbumList()},pickAlbum(e){this.$emit("album-picked",e)},isSharedAlbum(e){return e.path.match(/^\/photos\/.+\/sharedalbums\//)!==null},originalName(e){return this.isSharedAlbum(e)?e.basename.replace(new RegExp("\\(".concat(e.attributes.collaborators[0].id,"\\)$")),""):e.basename},t:h,n:_}});var ee=function(){var e=this,t=e._self._c;return e._self._setupProxy,e.showAlbumCreationForm?t("AlbumForm",{attrs:{"display-back-button":!0,title:e.t("photos","New album")},on:{back:function(o){e.showAlbumCreationForm=!1},done:e.albumCreatedHandler}}):t("div",{staticClass:"album-picker"},[t("h2",[e._v(" "+e._s(e.t("photos","Add to Album"))+" "),e.loadingCollections?t("NcLoadingIcon",{staticClass:"loading-icon"}):e._e()],1),t("ul",{staticClass:"albums-container"},e._l(e.allAlbums,function(o){return t("NcListItem",{key:o.attributes.filename,staticClass:"album",attrs:{name:e.originalName(o),"aria-label":e.t("photos","Add selection to album {albumName}",{albumName:o.basename})},on:{click:function(s){return e.pickAlbum(o)}},scopedSlots:e._u([{key:"subname",fn:function(){return[e._v(" "+e._s(e.n("photos","%n item","%n photos and videos",o.attributes.nbItems))+" "),e.isSharedAlbum(o)?[e._v(" ⸱ "+e._s(e.t("photos","Shared by"))+" "),t("NcUserBubble",{attrs:{"display-name":o.attributes.collaborators[0].label,user:o.attributes.collaborators[0].id}})]:e._e()]},proxy:!0}],null,!0)},[t("template",{slot:"icon"},[o.attributes["last-photo"]!==-1?t("img",{staticClass:"album__image",attrs:{src:e._f("toCoverUrl")(o.attributes["last-photo"])}}):t("div",{staticClass:"album__image album__image--placeholder"},[t("ImageMultipleOutline",{attrs:{size:32}})],1)])],2)}),1),t("NcButton",{staticClass:"new-album-button",attrs:{"aria-label":e.t("photos","Create a new album."),variant:"tertiary"},on:{click:function(o){e.showAlbumCreationForm=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Plus")]},proxy:!0}],null,!1,1489515321)},[e._v(" "+e._s(e.t("photos","Create new album"))+" ")])],1)},te=[],oe=b(Z,ee,te,!1,null,"9619a86f");const se=oe.exports;async function d(e,t){await M.head(e);const o=document.createElement("a");o.download=t!=null?t:"",o.href=e,o.click()}function ie(e,t){const o=e.split("/").filter(Boolean),s=t.split("/").filter(Boolean);let i="";for(const[a,l]of o.entries()){if(a>=t.length||l!==s[a])break;const F=i===""?"":"/";i="".concat(i).concat(F).concat(l)}return i}async function ae(e){let t;if(e.length===1)if(e[0].type===w.File){await d(e[0].encodedSource,e[0].displayname);return}else t=new URL(e[0].encodedSource),t.searchParams.append("accept","zip");else{t=new URL(e[0].encodedSource);let o=t.pathname;for(const i of e.slice(1))o=ie(o,new URL(i.encodedSource).pathname);t.pathname=o;const s=e.map(i=>decodeURIComponent(i.encodedSource.slice(t.href.length+1)));t.searchParams.append("accept","zip"),t.searchParams.append("files",JSON.stringify(s))}t.pathname.at(-1)!=="/"&&(t.pathname="".concat(t.pathname,"/")),await d(t.href)}const le={name:"TimelineView",components:{DeleteOutline:H,PlusBoxMultipleOutline:V,DownloadOutline:E,Close:$,Plus:f,FolderAlertOutline:Y,NcEmptyContent:T,NcModal:L,NcActions:O,NcActionButton:P,NcButton:p,AlbumForm:y,AlbumPicker:se,FilesListViewer:G,FileComponent:q,ActionFavorite:R,HeaderNavigation:K,PhotosSourceLocationsSettings:N,AlertCircleOutline:D},filters:{dateMonth(e){return r(e,"YYYYMM").format("MMMM")},dateYear(e){return r(e,"YYYYMM").format("YYYY")}},mixins:[W,J,X],beforeRouteLeave(e,t,o){var s;(s=this.appContent)==null||s.scrollTo(0,0),o(),Object.keys(this.selectedFilters).forEach(i=>{this.selectedFilters[i]=[]})},props:{onlyFavorites:{type:Boolean,default:!1},mimesType:{type:Array,default:()=>I},onThisDay:{type:Boolean,default:!1},rootTitle:{type:String,required:!0}},setup(){const e=v(),t=S(),{selectedFilters:o,filtersQuery:s}=B(t);return{isMobile:e,selectedFilters:o,filtersQuery:s}},data(){return{loadingCount:0,showAlbumCreationForm:!1,showAlbumPicker:!1,appContent:document.getElementById("app-content-vue"),showFilters:!1}},computed:{files(){return this.$store.state.files.files},createAlbumButtonLabel(){return Object.keys(this.selectedFilters).length>0?this.t("photos","Create new album from filters"):this.t("photos","Create new album")}},watch:{filtersQuery(){this.resetFetchFilesState(),this.getContent()}},mounted(){k(m,this.handleUserConfigChange)},destroyed(){g(m,this.handleUserConfigChange)},methods:{getContent(){this.fetchFiles({mimesType:this.mimesType,onThisDay:this.onThisDay,onlyFavorites:this.onlyFavorites,extraFilters:this.filtersQuery})},openViewer(e){window.OCA.Viewer.open({fileInfo:u(this.files[e]),list:Object.values(this.fileIdsByMonth).flat().map(t=>u(this.files[t]))})},openUploader(){},async addSelectionToAlbum(e){this.showAlbumPicker=!1,await this.$store.dispatch("addFilesToCollection",{collectionFileName:e.root+e.path,fileIdsToAdd:this.selectedFileIds})},async deleteSelection(){const e=this.selectedFileIds;this.onUncheckFiles(e),this.fetchedFileIds=this.fetchedFileIds.filter(t=>!e.includes(t)),await this.$store.dispatch("deleteFiles",e)},handleUserConfigChange({key:e}){e==="photosSourceFolders"&&this.resetFetchFilesState()},handleFormCreationDone({album:e}){this.showAlbumCreationForm=!1,this.$router.push("/albums/".concat(e.basename))},downloadSelectedFiles(){const e=this.selectedFileIds;this.onUncheckFiles(e),ae(e.map(t=>this.files[t]))},t:h}};var ne=function(){var o;var e=this,t=e._self._c;return e.errorFetchingFiles?t("div",{staticClass:"timeline__empty-content"},[e.errorFetchingFiles===404?t("NcEmptyContent",{attrs:{name:e.t("photos","One of the source folders does not exist")}},[t("FolderAlertOutline",{attrs:{slot:"icon"},slot:"icon"}),t("PhotosSourceLocationsSettings",{staticClass:"timeline__update_source_directory",attrs:{slot:"action"},slot:"action"})],1):t("NcEmptyContent",{attrs:{name:e.t("photos","An error occurred")}},[t("AlertCircleOutline",{attrs:{slot:"icon"},slot:"icon"})],1)],1):t("div",{staticClass:"timeline"},[t("HeaderNavigation",{key:"navigation",attrs:{loading:e.loadingCount>0,path:"/",title:e.rootTitle,"root-title":e.rootTitle},on:{refresh:e.resetFetchFilesState}},[t("div",{staticClass:"timeline__header__left"},[e.selectedFileIds.length===0?t("NcButton",{ref:"newAlbumButton",attrs:{"aria-label":e.createAlbumButtonLabel,"data-cy-header-action":"create-album"},on:{click:function(s){e.showAlbumCreationForm=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("PlusBoxMultipleOutline")]},proxy:!0}],null,!1,2448450972)},[e._v(" "+e._s(e.createAlbumButtonLabel)+" ")]):[t("NcButton",{attrs:{"close-after-click":!0,variant:"primary","aria-label":e.t("photos","Add to album"),"data-cy-header-action":"add-to-album"},on:{click:function(s){e.showAlbumPicker=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Plus")]},proxy:!0},e.isMobile?null:{key:"default",fn:function(){return[e._v(" "+e._s(e.t("photos","Add to album"))+" ")]},proxy:!0}],null,!0)}),e.selectedFileIds.length>0?t("NcButton",{attrs:{"aria-label":e.t("photos","Unselect all"),"data-cy-header-action":"unselect-all"},on:{click:e.resetSelection},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Close")]},proxy:!0},e.isMobile?null:{key:"default",fn:function(){return[e._v(" "+e._s(e.t("photos","Unselect all"))+" ")]},proxy:!0}],null,!0)}):e._e(),t("NcActions",{attrs:{"aria-label":e.t("photos","Open actions menu")}},[t("NcActionButton",{attrs:{"data-cy-header-action":"download-selection","close-after-click":!0,"aria-label":e.t("photos","Download selected files")},on:{click:e.downloadSelectedFiles},scopedSlots:e._u([{key:"icon",fn:function(){return[t("DownloadOutline")]},proxy:!0}])},[e._v(" "+e._s(e.t("photos","Download selected files"))+" ")]),t("ActionFavorite",{attrs:{"selected-file-ids":e.selectedFileIds}}),t("NcActionButton",{attrs:{"close-after-click":!0,"aria-label":e.t("photos","Delete selection"),"data-cy-header-action":"delete-selection"},on:{click:e.deleteSelection},scopedSlots:e._u([{key:"icon",fn:function(){return[t("DeleteOutline")]},proxy:!0}])},[e._v(" "+e._s(e.t("photos","Delete selection"))+" ")])],1)]],2)]),t("FilesListViewer",{ref:"filesListViewer",staticClass:"timeline__file-list",attrs:{"container-element":e.appContent,"file-ids-by-section":e.fileIdsByMonth,sections:e.monthsList,loading:e.loadingFiles,"base-height":e.isMobile?120:200,"empty-message":e.t("photos","No photos or videos in here")},on:{"need-content":e.getContent},scopedSlots:e._u([{key:"default",fn:function({file:s,isHeader:i,distance:a}){return[i?t("h2",{staticClass:"section-header",attrs:{id:"file-picker-section-header-".concat(s.id)}},[t("b",[e._v(e._s(e._f("dateMonth")(s.id)))]),e._v(" "+e._s(e._f("dateYear")(s.id))+" ")]):t("FileComponent",{attrs:{file:e.files[s.id],"allow-selection":!0,selected:e.selection[s.id]===!0,distance:a},on:{click:e.openViewer,"select-toggled":e.onFileSelectToggle}})]}}])}),e.showAlbumCreationForm?t("NcModal",{key:"albumCreationForm",attrs:{"label-id":"new-album-form","set-return-focus":(o=e.$refs.newAlbumButton)==null?void 0:o.$el},on:{close:function(s){e.showAlbumCreationForm=!1}}},[t("h2",{staticClass:"timeline__heading"},[e._v(" "+e._s(e.t("photos","New album"))+" ")]),t("AlbumForm",{attrs:{"filters-value":e.selectedFilters},on:{done:e.handleFormCreationDone}})],1):e._e(),e.showAlbumPicker?t("NcModal",{key:"albumPicker",attrs:{"label-id":"album-picker"},on:{close:function(s){e.showAlbumPicker=!1}}},[t("AlbumPicker",{on:{"album-picked":e.addSelectionToAlbum}})],1):e._e()],1)},re=[],ce=b(le,ne,re,!1,null,"646f350e");const Je=ce.exports;export{Je as default};
//# sourceMappingURL=TimelineView-BbtatdQo.chunk.mjs.map

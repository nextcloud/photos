import{d as w,p as C,t as f,u as n,h as g,G as k,H as v,v as r,x as c}from"./index-Cyn8tcq_.chunk.mjs";import{m as u}from"./index-BKNYV8jx.chunk.mjs";import{N as S}from"./NcActionButton-DykQxmXJ-DfC4xMBk.chunk.mjs";import{N,a as B}from"./NcColorPicker-CYzA8Dxx.chunk.mjs";import"./NcProgressBar-D7zYeXBH-BJ-8evEW.chunk.mjs";import"./NcBreadcrumbs-BPfsSByZ-BD4lMBVt.chunk.mjs";import"./NcAvatar-D5nljVEA-CqudfoYn.chunk.mjs";import{y as O,k as F,w as m,V as x,a as M,z as P,u as I,l as d,D as p,W as h,B as $}from"./index-DX2SbTk6.chunk.mjs";import"./video-CN-8rN3C.chunk.mjs";import"./NcFormBoxButton-C6EvdLK4-B04j2RhN.chunk.mjs";import"./useHotKey-U4kMc8_n.chunk.mjs";import"./createElementId-DhjFt1I9-B2HCdIOx.chunk.mjs";import"./NcCheckboxRadioSwitch-DAPHFb0L-C5yI6tHT.chunk.mjs";import"./useFormatDateTime-BLrrQzS3.chunk.mjs";import"./NcDateTimePicker-CPx6U3yK.chunk.mjs";import"./NcSelect-DTniMiUS-BSLDsywC.chunk.mjs";import{N as L}from"./NcEmptyContent-BUSMgf3R.chunk.mjs";import"./NcTextField-CfZknuqx-NIse9ogT.chunk.mjs";import"./NcSelectUsers-RyUVUaWQ-CJ0Vfb-h.chunk.mjs";import{N as T}from"./NcUserBubble-VLY4hn5K-aXVRNSK2.chunk.mjs";import{P as U,u as D,s as Y}from"./filters-BXbx-mqi.chunk.mjs";import{I as V,P as y,n as A,A as E,F as H,e as j,k as R,p as z,D as Q}from"./icons-CDOHk7t6.chunk.mjs";import{A as q}from"./ActionFavorite-6gjTUENI.chunk.mjs";import{A as _}from"./AlbumForm-DlHoBDr3.chunk.mjs";import{F as G}from"./FetchCollectionsMixin-DGrDce0A.chunk.mjs";import{F as J}from"./FileComponent-BeLIm01X.chunk.mjs";import{F as W,a as K}from"./FilesSelectionMixin-D6tIj8IU.chunk.mjs";import{H as X}from"./HeaderNavigation-TGG6NM0U.chunk.mjs";import{F as Z}from"./FetchFilesMixin-BGjXWQ25.chunk.mjs";import{F as ee}from"./FilesByMonthMixin-BPnJvdZQ.chunk.mjs";import"./index-BZR1y71w.chunk.mjs";import"./useModelMigration-EhAWvqDD-B5MytT5w.chunk.mjs";import"./index-BEAJDltQ.chunk.mjs";import"./PhotosFiltersInput-DYeZZqxp.chunk.mjs";import"./NcDateTime-enXYuwj8-DgMXXVsl.chunk.mjs";import"./collectionFetcher-Dc1KYokQ.chunk.mjs";import"./index-x9vhq81Z.chunk.mjs";import"./FetchCollectionContentMixin-67X8q0Tu.chunk.mjs";import"./AbortControllerMixin-Dh9iWmJw.chunk.mjs";import"./fileFetcher-BQ4eAwfl.chunk.mjs";import"./PhotoSearch-C9A9-R6q.chunk.mjs";const te=w({name:"AlbumPicker",components:{Plus:y,ImageMultipleOutline:V,NcButton:F,NcListItem:N,NcLoadingIcon:O,NcUserBubble:T,AlbumForm:_},filters:{toCoverUrl(e){return g(`/apps/photos/api/v1/preview/${e}?x=64&y=64`)}},mixins:[G],data(){return{showAlbumCreationForm:!1}},computed:{albums(){return this.$store.getters.albums},sharedAlbums(){return this.$store.getters.sharedAlbums},allAlbums(){return[...Object.values(this.albums),...Object.values(this.sharedAlbums)]}},mounted(){this.fetchAlbumList()},methods:{async fetchAlbumList(){await this.fetchCollections(`/photos/${n()?.uid}/albums`,m),await this.fetchCollections(`/photos/${n()?.uid}/sharedalbums`,m)},albumCreatedHandler(){this.showAlbumCreationForm=!1,this.fetchAlbumList()},pickAlbum(e){this.$emit("album-picked",e)},isSharedAlbum(e){return e.path.match(/^\/photos\/.+\/sharedalbums\//)!==null},originalName(e){return this.isSharedAlbum(e)?e.basename.replace(new RegExp(`\\(${e.attributes.collaborators[0].id}\\)$`),""):e.basename},t:f,n:C}});var oe=function(){var e=this,t=e._self._c;return e._self._setupProxy,e.showAlbumCreationForm?t("AlbumForm",{attrs:{"display-back-button":!0,title:e.t("photos","New album")},on:{back:function(o){e.showAlbumCreationForm=!1},done:e.albumCreatedHandler}}):t("div",{staticClass:"album-picker"},[t("h2",[e._v(" "+e._s(e.t("photos","Add to Album"))+" "),e.loadingCollections?t("NcLoadingIcon",{staticClass:"loading-icon"}):e._e()],1),t("ul",{staticClass:"albums-container"},e._l(e.allAlbums,function(o){return t("NcListItem",{key:o.attributes.filename,staticClass:"album",attrs:{name:e.originalName(o),"aria-label":e.t("photos","Add selection to album {albumName}",{albumName:o.basename})},on:{click:function(s){return e.pickAlbum(o)}},scopedSlots:e._u([{key:"subname",fn:function(){return[e._v(" "+e._s(e.n("photos","%n item","%n photos and videos",o.attributes.nbItems))+" "),e.isSharedAlbum(o)?[e._v(" ⸱ "+e._s(e.t("photos","Shared by"))+" "),t("NcUserBubble",{attrs:{"display-name":o.attributes.collaborators[0].label,user:o.attributes.collaborators[0].id}})]:e._e()]},proxy:!0}],null,!0)},[t("template",{slot:"icon"},[o.attributes["last-photo"]!==-1?t("img",{staticClass:"album__image",attrs:{src:e._f("toCoverUrl")(o.attributes["last-photo"])}}):t("div",{staticClass:"album__image album__image--placeholder"},[t("ImageMultipleOutline",{attrs:{size:32}})],1)])],2)}),1),t("NcButton",{staticClass:"new-album-button",attrs:{"aria-label":e.t("photos","Create a new album."),variant:"tertiary"},on:{click:function(o){e.showAlbumCreationForm=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Plus")]},proxy:!0}],null,!1,1489515321)},[e._v(" "+e._s(e.t("photos","Create new album"))+" ")])],1)},se=[],ie=A(te,oe,se,!1,null,"9619a86f");const ae=ie.exports;async function b(e,t){await x.head(e);const o=document.createElement("a");o.download=t??"",o.href=e,o.click()}function le(e,t){const o=e.split("/").filter(Boolean),s=t.split("/").filter(Boolean);let i="";for(const[a,l]of o.entries()){if(a>=t.length||l!==s[a])break;i=`${i}${i===""?"":"/"}${l}`}return i}async function ne(e){let t;if(e.length===1)if(e[0].type===k.File){await b(e[0].encodedSource,e[0].displayname);return}else t=new URL(e[0].encodedSource),t.searchParams.append("accept","zip");else{t=new URL(e[0].encodedSource);let o=t.pathname;for(const i of e.slice(1))o=le(o,new URL(i.encodedSource).pathname);t.pathname=o;const s=e.map(i=>decodeURIComponent(i.encodedSource.slice(t.href.length+1)));t.searchParams.append("accept","zip"),t.searchParams.append("files",JSON.stringify(s))}t.pathname.at(-1)!=="/"&&(t.pathname=`${t.pathname}/`),await b(t.href)}const re=v(),ce={name:"TimelineView",components:{DeleteOutline:Q,PlusBoxMultipleOutline:z,DownloadOutline:R,Close:j,Plus:y,FolderAlertOutline:H,NcEmptyContent:L,NcModal:I,NcActions:P,NcActionButton:S,NcButton:F,NcAppSidebar:B,AlbumForm:_,AlbumPicker:ae,FilesListViewer:K,FileComponent:J,ActionFavorite:q,HeaderNavigation:X,PhotosSourceLocationsSettings:U,AlertCircleOutline:E},filters:{dateMonth(e){return u(e,"YYYYMM").format("MMMM")},dateYear(e){return u(e,"YYYYMM").format("YYYY")}},mixins:[Z,W,ee],beforeRouteLeave(e,t,o){this.appContent?.scrollTo(0,0),o(),Object.keys(this.selectedFilters).forEach(s=>{this.selectedFilters[s]=[]})},props:{onlyFavorites:{type:Boolean,default:!1},mimesType:{type:Array,default:()=>M},onThisDay:{type:Boolean,default:!1},rootTitle:{type:String,required:!0}},setup(){const e=$(),t=D(),{selectedFilters:o,filtersQuery:s}=Y(t);return{isMobile:e,selectedFilters:o,filtersQuery:s}},data(){return{loadingCount:0,showAlbumCreationForm:!1,showAlbumPicker:!1,appContent:document.getElementById("app-content-vue"),showFilters:!1,selectedFile:null}},computed:{files(){return this.$store.state.files.files},createAlbumButtonLabel(){return Object.keys(this.selectedFilters).length>0?this.t("photos","Create new album from filters"):this.t("photos","Create new album")}},watch:{filtersQuery(){this.resetFetchFilesState(),this.getContent()}},mounted(){c(h,this.handleUserConfigChange),c("viewer:sidebar:open",this.handleViewerSidebarOpen)},destroyed(){r(h,this.handleUserConfigChange),r("viewer:sidebar:open",this.handleViewerSidebarOpen)},methods:{getContent(){this.fetchFiles({mimesType:this.mimesType,onThisDay:this.onThisDay,onlyFavorites:this.onlyFavorites,extraFilters:this.filtersQuery})},openViewer(e){window.OCA.Viewer.open({fileInfo:p(this.files[e]),list:Object.values(this.fileIdsByMonth).flat().map(t=>p(this.files[t])),enabledSidebar:!0})},openUploader(){},async addSelectionToAlbum(e){this.showAlbumPicker=!1,await this.$store.dispatch("addFilesToCollection",{collectionFileName:e.root+e.path,fileIdsToAdd:this.selectedFileIds})},async deleteSelection(){const e=this.selectedFileIds;this.onUncheckFiles(e),this.fetchedFileIds=this.fetchedFileIds.filter(t=>!e.includes(t)),await this.$store.dispatch("deleteFiles",e)},handleUserConfigChange({key:e}){e==="photosSourceFolders"&&this.resetFetchFilesState()},handleViewerSidebarOpen({source:e}){this.selectedFile=Object.values(this.files).find(t=>t.source===e),this.selectedFile?(d.debug("Opening sidebar for node from Viewer.",{node:this.selectedFile}),re.open(this.selectedFile)):d.error(`Cannot open sidebar for node '${e}' because it was not found in the current view.`)},handleFormCreationDone({album:e}){this.showAlbumCreationForm=!1,this.$router.push(`/albums/${e.basename}`)},downloadSelectedFiles(){const e=this.selectedFileIds;this.onUncheckFiles(e),ne(e.map(t=>this.files[t]))},t:f}};var ue=function(){var e=this,t=e._self._c;return e.errorFetchingFiles?t("div",{staticClass:"timeline__empty-content"},[e.errorFetchingFiles===404?t("NcEmptyContent",{attrs:{name:e.t("photos","One of the source folders does not exist")}},[t("FolderAlertOutline",{attrs:{slot:"icon"},slot:"icon"}),t("PhotosSourceLocationsSettings",{staticClass:"timeline__update_source_directory",attrs:{slot:"action"},slot:"action"})],1):t("NcEmptyContent",{attrs:{name:e.t("photos","An error occurred")}},[t("AlertCircleOutline",{attrs:{slot:"icon"},slot:"icon"})],1)],1):t("div",{staticClass:"timeline"},[t("HeaderNavigation",{key:"navigation",attrs:{loading:e.loadingCount>0,path:"/",title:e.rootTitle,"root-title":e.rootTitle},on:{refresh:e.resetFetchFilesState}},[t("div",{staticClass:"timeline__header__left"},[e.selectedFileIds.length===0?t("NcButton",{ref:"newAlbumButton",attrs:{"aria-label":e.createAlbumButtonLabel,"data-cy-header-action":"create-album"},on:{click:function(o){e.showAlbumCreationForm=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("PlusBoxMultipleOutline")]},proxy:!0}],null,!1,2448450972)},[e._v(" "+e._s(e.createAlbumButtonLabel)+" ")]):[t("NcButton",{attrs:{"close-after-click":!0,variant:"primary","aria-label":e.t("photos","Add to album"),"data-cy-header-action":"add-to-album"},on:{click:function(o){e.showAlbumPicker=!0}},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Plus")]},proxy:!0},e.isMobile?null:{key:"default",fn:function(){return[e._v(" "+e._s(e.t("photos","Add to album"))+" ")]},proxy:!0}],null,!0)}),e.selectedFileIds.length>0?t("NcButton",{attrs:{"aria-label":e.t("photos","Unselect all"),"data-cy-header-action":"unselect-all"},on:{click:e.resetSelection},scopedSlots:e._u([{key:"icon",fn:function(){return[t("Close")]},proxy:!0},e.isMobile?null:{key:"default",fn:function(){return[e._v(" "+e._s(e.t("photos","Unselect all"))+" ")]},proxy:!0}],null,!0)}):e._e(),t("NcActions",{attrs:{"aria-label":e.t("photos","Open actions menu")}},[t("NcActionButton",{attrs:{"data-cy-header-action":"download-selection","close-after-click":!0,"aria-label":e.t("photos","Download selected files")},on:{click:e.downloadSelectedFiles},scopedSlots:e._u([{key:"icon",fn:function(){return[t("DownloadOutline")]},proxy:!0}])},[e._v(" "+e._s(e.t("photos","Download selected files"))+" ")]),t("ActionFavorite",{attrs:{"selected-file-ids":e.selectedFileIds}}),t("NcActionButton",{attrs:{"close-after-click":!0,"aria-label":e.t("photos","Delete selection"),"data-cy-header-action":"delete-selection"},on:{click:e.deleteSelection},scopedSlots:e._u([{key:"icon",fn:function(){return[t("DeleteOutline")]},proxy:!0}])},[e._v(" "+e._s(e.t("photos","Delete selection"))+" ")])],1)]],2)]),t("FilesListViewer",{ref:"filesListViewer",staticClass:"timeline__file-list",attrs:{"container-element":e.appContent,"file-ids-by-section":e.fileIdsByMonth,sections:e.monthsList,loading:e.loadingFiles,"base-height":e.isMobile?120:200,"empty-message":e.t("photos","No photos or videos in here")},on:{"need-content":e.getContent},scopedSlots:e._u([{key:"default",fn:function({file:o,isHeader:s}){return[s?t("h2",{staticClass:"section-header",attrs:{id:`file-picker-section-header-${o.id}`}},[t("b",[e._v(e._s(e._f("dateMonth")(o.id)))]),e._v(" "+e._s(e._f("dateYear")(o.id))+" ")]):t("FileComponent",{attrs:{file:e.files[o.id],"allow-selection":!0,selected:e.selection[o.id]===!0},on:{click:e.openViewer,"select-toggled":e.onFileSelectToggle}})]}}])}),t("NcAppSidebar",{attrs:{open:e.selectedFile!==null,"no-toggle":"",name:e.selectedFile?.displayname??""}}),e.showAlbumCreationForm?t("NcModal",{key:"albumCreationForm",attrs:{"label-id":"new-album-form","set-return-focus":e.$refs.newAlbumButton?.$el},on:{close:function(o){e.showAlbumCreationForm=!1}}},[t("h2",{staticClass:"timeline__heading"},[e._v(" "+e._s(e.t("photos","New album"))+" ")]),t("AlbumForm",{attrs:{"filters-value":e.selectedFilters},on:{done:e.handleFormCreationDone}})],1):e._e(),e.showAlbumPicker?t("NcModal",{key:"albumPicker",attrs:{"label-id":"album-picker"},on:{close:function(o){e.showAlbumPicker=!1}}},[t("AlbumPicker",{on:{"album-picked":e.addSelectionToAlbum}})],1):e._e()],1)},me=[],de=A(ce,ue,me,!1,null,"2ce8e2f3");const et=de.exports;export{et as default};
//# sourceMappingURL=TimelineView-CQUz8GHa.chunk.mjs.map

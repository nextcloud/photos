{"version":3,"file":"collectionFetcher-COU0Vwo3.chunk.mjs","sources":["../src/services/collectionFetcher.ts"],"sourcesContent":["/**\n * SPDX-FileCopyrightText: 2022 Nextcloud GmbH and Nextcloud contributors\n * SPDX-License-Identifier: AGPL-3.0-or-later\n */\n\nimport type { File, Folder } from '@nextcloud/files'\nimport type { FileStat, ResponseDataDetailed, StatOptions, WebDAVClient } from 'webdav'\n\nimport { resultToNode } from '@nextcloud/files/dav'\nimport { t } from '@nextcloud/l10n'\nimport moment from '@nextcloud/moment'\nimport { davClient } from './DavClient.ts'\nimport logger from './logger.js'\n\nexport type Collection = Folder & {\n\tattributes: {\n\t\tnbItems: number // The number of item in the collection.\n\t\t'last-photo': number // The file id for the cover of the collection.\n\t}\n}\n\nexport type RawCollection = FileStat & {\n\tprops: {\n\t\tcollaborators: '' | { collaborator: object[] | object } | object[]\n\t\tdateRange: string\n\t}\n}\n\n/**\n *\n * @param extraProps\n */\nfunction getCollectionDavRequest(extraProps: string[] = []): string {\n\treturn `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<nc:last-photo />\n\t\t\t\t\t<nc:nbItems />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`\n}\n\n/**\n *\n * @param extraProps\n */\nfunction getCollectionFilesDavRequest(extraProps: string[] = []): string {\n\treturn `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<d:getcontentlength />\n\t\t\t\t\t<d:getcontenttype />\n\t\t\t\t\t<d:getetag />\n\t\t\t\t\t<d:getlastmodified />\n\t\t\t\t\t<d:resourcetype />\n\t\t\t\t\t<nc:metadata-photos-size />\n\t\t\t\t\t<nc:metadata-photos-original_date_time />\n\t\t\t\t\t<nc:metadata-files-live-photo />\n\t\t\t\t\t<nc:has-preview />\n\t\t\t\t\t<nc:hidden />\n\t\t\t\t\t<oc:favorite />\n\t\t\t\t\t<oc:fileid />\n\t\t\t\t\t<oc:permissions />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`\n}\n\n/**\n *\n * @param path\n * @param options\n * @param extraProps\n * @param client\n */\nexport async function fetchCollection(path: string, options: StatOptions, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<Collection | null> {\n\ttry {\n\t\tconst response = await client.stat(path, {\n\t\t\tdata: getCollectionDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<RawCollection>\n\n\t\tlogger.debug('[Collections] Fetched a collection: ', { data: response.data })\n\n\t\treturn formatCollection(response.data, path.split('/').slice(0, -1).join('/'))\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn null\n\t\t}\n\n\t\tthrow error\n\t}\n}\n\n/**\n *\n * @param path\n * @param options\n * @param extraProps\n * @param client\n */\nexport async function fetchCollections(path: string, options: StatOptions = {}, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<Collection[]> {\n\ttry {\n\t\tconst response = await client.getDirectoryContents(path, {\n\t\t\tdata: getCollectionDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<Array<RawCollection>>\n\n\t\tlogger.debug(`[Collections] Fetched ${response.data.length} collections: `, { data: response.data })\n\n\t\treturn response.data\n\t\t\t.filter((collection) => collection.filename !== path)\n\t\t\t.map((rawCollection) => formatCollection(rawCollection, path))\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn []\n\t\t}\n\n\t\tthrow error\n\t}\n}\n\n/**\n *\n * @param rawCollection\n * @param root\n */\nfunction formatCollection(rawCollection: RawCollection, root: string): Collection {\n\t// Ensure that we have a proper collaborators array.\n\tif (rawCollection.props.collaborators === undefined || rawCollection.props.collaborators === '') {\n\t\trawCollection.props.collaborators = []\n\t} else if (typeof rawCollection.props.collaborators.collaborator === 'object') {\n\t\tif (Array.isArray(rawCollection.props.collaborators.collaborator)) {\n\t\t\trawCollection.props.collaborators = rawCollection.props.collaborators.collaborator\n\t\t} else {\n\t\t\trawCollection.props.collaborators = [rawCollection.props.collaborators.collaborator]\n\t\t}\n\t}\n\n\t// Compute date range label.\n\tconst dateRange = JSON.parse(rawCollection.props.dateRange?.replace(/&quot;/g, '\"') ?? '{}')\n\tif (dateRange.start === null) {\n\t\tdateRange.start = moment().unix()\n\t\tdateRange.end = moment().unix()\n\t}\n\tconst dateRangeFormatted = {\n\t\tstartDate: moment.unix(dateRange.start).format('MMMM YYYY'),\n\t\tendDate: moment.unix(dateRange.end).format('MMMM YYYY'),\n\t}\n\tif (dateRangeFormatted.startDate === dateRangeFormatted.endDate) {\n\t\trawCollection.props.date = dateRangeFormatted.startDate\n\t} else {\n\t\trawCollection.props.date = t('photos', '{startDate} to {endDate}', dateRangeFormatted)\n\t}\n\n\trawCollection.props.filters = JSON.parse((rawCollection.props.filters as string | null) ?? '{}')\n\n\treturn resultToNode(rawCollection, root) as Collection\n}\n\n/**\n *\n * @param path\n * @param options\n * @param extraProps\n * @param client\n */\nexport async function fetchCollectionFiles(path: string, options: StatOptions, extraProps: string[] = [], client: WebDAVClient = davClient): Promise<File[]> {\n\ttry {\n\t\tconst response = await client.getDirectoryContents(path, {\n\t\t\tdata: getCollectionFilesDavRequest(extraProps),\n\t\t\tdetails: true,\n\t\t\t...options,\n\t\t}) as ResponseDataDetailed<Array<FileStat>>\n\n\t\tconst filesRoot = path.split('/').slice(0, -1).join('/')\n\t\tconst fetchedFiles = response.data\n\t\t\t.map((file) => resultToNode(file, filesRoot) as File)\n\t\t\t.filter((file) => file.fileid !== undefined)\n\n\t\tlogger.debug(`[Collections] Fetched ${fetchedFiles.length} new files: `, { fetchedFiles })\n\n\t\treturn fetchedFiles\n\t} catch (error) {\n\t\tif (error instanceof DOMException && error.code === error.ABORT_ERR) {\n\t\t\treturn []\n\t\t}\n\n\t\tlogger.error('Error fetching collection files', { error })\n\t\tthrow error\n\t}\n}\n"],"names":["t"],"mappings":"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"}
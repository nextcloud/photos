{"version":3,"file":"photos-src_views_Places_vue-src_services_collectionFetcher_js.js?v=84849d3943c9ffb5c337","mappings":";;;;;;;;;;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;AChDA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;AC9DA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACPA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;;;;;;;;;;;;;;;;AC1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAkBA;AACA;;;;;;;;;;;;;;;ACvCA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AGAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","sources":["webpack:///photos/src/views/Places.vue?vue&type=script&lang=js&","webpack:///photos/src/views/Places.vue?vue&type=template&id=0e7b5506&scoped=true&","webpack:///photos/src/views/Places.vue?vue&type=style&index=0&id=0e7b5506&lang=scss&scoped=true&","webpack://photos/./src/views/Places.vue?64bd","webpack:///photos/src/views/Places.vue","webpack://photos/./src/views/Places.vue?33bb","webpack://photos/./src/views/Places.vue?2a3e","webpack://photos/./src/views/Places.vue?89c8","webpack:///photos/src/services/collectionFetcher.js"],"sourcesContent":["import FolderMultipleImage from 'vue-material-design-icons/FolderMultipleImage.vue';\nimport { generateUrl } from '@nextcloud/router';\nimport { NcEmptyContent } from '@nextcloud/vue';\nimport { getCurrentUser } from '@nextcloud/auth';\nimport { translate, translatePlural } from '@nextcloud/l10n';\nimport FetchCollectionsMixin from '../mixins/FetchCollectionsMixin.js';\nimport CollectionsList from '../components/Collection/CollectionsList.vue';\nimport CollectionCover from '../components/Collection/CollectionCover.vue';\nimport HeaderNavigation from '../components/HeaderNavigation.vue';\nexport default {\n  name: 'Places',\n  components: {\n    FolderMultipleImage,\n    NcEmptyContent,\n    CollectionsList,\n    CollectionCover,\n    HeaderNavigation\n  },\n  filters: {\n    /**\n     * @param {string} fileId The place's last photo.\n     */\n    coverUrl(fileId) {\n      if (fileId === -1) {\n        return '';\n      }\n      return generateUrl(`/apps/photos/api/v1/preview/${fileId}?x=${512}&y=${512}`);\n    }\n  },\n  mixins: [FetchCollectionsMixin],\n  computed: {\n    /**\n     * @return {import('../services/collectionFetcher.js').IndexedCollections}\n     */\n    places() {\n      return this.$store.getters.places;\n    }\n  },\n  async beforeMount() {\n    this.fetchPlaces();\n  },\n  methods: {\n    fetchPlaces() {\n      this.fetchCollections(`/photos/${getCurrentUser()?.uid}/places`);\n    },\n    t: translate,\n    n: translatePlural\n  }\n};","var render = function render() {\n  var _vm = this,\n    _c = _vm._self._c;\n  return _c(\"div\", [_c(\"CollectionsList\", {\n    staticClass: \"places-list\",\n    attrs: {\n      collections: _vm.places,\n      loading: _vm.loadingCollections,\n      error: _vm.errorFetchingCollections\n    },\n    scopedSlots: _vm._u([{\n      key: \"default\",\n      fn: function (_ref) {\n        let {\n          collection\n        } = _ref;\n        return _c(\"CollectionCover\", {\n          key: collection.basename,\n          attrs: {\n            link: `/places/${collection.basename}`,\n            \"alt-img\": _vm.t(\"photos\", \"Cover photo for place {placeName}\", {\n              placeName: collection.basename\n            }),\n            \"cover-url\": _vm._f(\"coverUrl\")(collection.lastPhoto)\n          }\n        }, [_c(\"h2\", {\n          staticClass: \"place__name\"\n        }, [_vm._v(\"\\n\\t\\t\\t\\t\" + _vm._s(collection.basename) + \"\\n\\t\\t\\t\")]), _vm._v(\" \"), _c(\"div\", {\n          staticClass: \"place__details\",\n          attrs: {\n            slot: \"subtitle\"\n          },\n          slot: \"subtitle\"\n        }, [_vm._v(\"\\n\\t\\t\\t\\t\" + _vm._s(_vm.n(\"photos\", \"%n item\", \"%n photos and videos\", collection.nbItems)) + \"\\n\\t\\t\\t\")])]);\n      }\n    }])\n  }, [_c(\"HeaderNavigation\", {\n    key: \"navigation\",\n    attrs: {\n      slot: \"header\",\n      loading: _vm.loadingCollections,\n      title: _vm.t(\"photos\", \"Places\"),\n      \"root-title\": _vm.t(\"photos\", \"Places\")\n    },\n    on: {\n      refresh: _vm.fetchPlaces\n    },\n    slot: \"header\"\n  }), _vm._v(\" \"), _vm._v(\" \"), _c(\"NcEmptyContent\", {\n    attrs: {\n      slot: \"empty-collections-list\",\n      name: _vm.t(\"photos\", \"There is no place yet!\")\n    },\n    slot: \"empty-collections-list\"\n  }, [_c(\"FolderMultipleImage\", {\n    attrs: {\n      slot: \"icon\"\n    },\n    slot: \"icon\"\n  })], 1)], 1)], 1);\n};\nvar staticRenderFns = [];\nrender._withStripped = true;\nexport { render, staticRenderFns };","// Imports\nimport ___CSS_LOADER_API_NO_SOURCEMAP_IMPORT___ from \"../../node_modules/css-loader/dist/runtime/noSourceMaps.js\";\nimport ___CSS_LOADER_API_IMPORT___ from \"../../node_modules/css-loader/dist/runtime/api.js\";\nvar ___CSS_LOADER_EXPORT___ = ___CSS_LOADER_API_IMPORT___(___CSS_LOADER_API_NO_SOURCEMAP_IMPORT___);\n// Module\n___CSS_LOADER_EXPORT___.push([module.id, \".places-list[data-v-0e7b5506] {\\n  display: flex;\\n  flex-direction: column;\\n}\\n.places-list .place__name[data-v-0e7b5506] {\\n  font-weight: normal;\\n  overflow: hidden;\\n  white-space: nowrap;\\n  text-overflow: ellipsis;\\n}\", \"\"]);\n// Exports\nexport default ___CSS_LOADER_EXPORT___;\n","\n      import API from \"!../../node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js\";\n      import domAPI from \"!../../node_modules/style-loader/dist/runtime/styleDomAPI.js\";\n      import insertFn from \"!../../node_modules/style-loader/dist/runtime/insertBySelector.js\";\n      import setAttributes from \"!../../node_modules/style-loader/dist/runtime/setAttributesWithoutAttributes.js\";\n      import insertStyleElement from \"!../../node_modules/style-loader/dist/runtime/insertStyleElement.js\";\n      import styleTagTransformFn from \"!../../node_modules/style-loader/dist/runtime/styleTagTransform.js\";\n      import content, * as namedExport from \"!!../../node_modules/css-loader/dist/cjs.js!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/dist/cjs.js!../../node_modules/sass-loader/dist/cjs.js??clonedRuleSet-2.use[3]!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=style&index=0&id=0e7b5506&lang=scss&scoped=true&\";\n      \n      \n\nvar options = {};\n\noptions.styleTagTransform = styleTagTransformFn;\noptions.setAttributes = setAttributes;\n\n      options.insert = insertFn.bind(null, \"head\");\n    \noptions.domAPI = domAPI;\noptions.insertStyleElement = insertStyleElement;\n\nvar update = API(content, options);\n\n\n\nexport * from \"!!../../node_modules/css-loader/dist/cjs.js!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/dist/cjs.js!../../node_modules/sass-loader/dist/cjs.js??clonedRuleSet-2.use[3]!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=style&index=0&id=0e7b5506&lang=scss&scoped=true&\";\n       export default content && content.locals ? content.locals : undefined;\n","import { render, staticRenderFns } from \"./Places.vue?vue&type=template&id=0e7b5506&scoped=true&\"\nimport script from \"./Places.vue?vue&type=script&lang=js&\"\nexport * from \"./Places.vue?vue&type=script&lang=js&\"\nimport style0 from \"./Places.vue?vue&type=style&index=0&id=0e7b5506&lang=scss&scoped=true&\"\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  \"0e7b5506\",\n  null\n  \n)\n\n/* hot reload */\nif (module.hot) {\n  var api = require(\"/home/louis/workspace/nextcloud/apps/photos/node_modules/vue-hot-reload-api/dist/index.js\")\n  api.install(require('vue'))\n  if (api.compatible) {\n    module.hot.accept()\n    if (!api.isRecorded('0e7b5506')) {\n      api.createRecord('0e7b5506', component.options)\n    } else {\n      api.reload('0e7b5506', component.options)\n    }\n    module.hot.accept(\"./Places.vue?vue&type=template&id=0e7b5506&scoped=true&\", function () {\n      api.rerender('0e7b5506', {\n        render: render,\n        staticRenderFns: staticRenderFns\n      })\n    })\n  }\n}\ncomponent.options.__file = \"src/views/Places.vue\"\nexport default component.exports","import mod from \"-!../../node_modules/babel-loader/lib/index.js!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=script&lang=js&\"; export default mod; export * from \"-!../../node_modules/babel-loader/lib/index.js!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=script&lang=js&\"","export * from \"-!../../node_modules/babel-loader/lib/index.js!../../node_modules/vue-loader/lib/loaders/templateLoader.js??ruleSet[1].rules[3]!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=template&id=0e7b5506&scoped=true&\"","export * from \"-!../../node_modules/style-loader/dist/cjs.js!../../node_modules/css-loader/dist/cjs.js!../../node_modules/vue-loader/lib/loaders/stylePostLoader.js!../../node_modules/postcss-loader/dist/cjs.js!../../node_modules/sass-loader/dist/cjs.js??clonedRuleSet-2.use[3]!../../node_modules/vue-loader/lib/index.js??vue-loader-options!./Places.vue?vue&type=style&index=0&id=0e7b5506&lang=scss&scoped=true&\"","/**\n * @copyright Copyright (c) 2022 Louis Chemineau <louis@chmn.me>\n *\n * @author Louis Chemineau <louis@chmn.me>\n *\n * @license AGPL-3.0-or-later\n *\n * This program is free software: you can redistribute it and/or modify\n * it under the terms of the GNU Affero General Public License as\n * published by the Free Software Foundation, either version 3 of the\n * License, or (at your option) any later version.\n *\n * This program is distributed in the hope that it will be useful,\n * but WITHOUT ANY WARRANTY; without even the implied warranty of\n * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n * GNU Affero General Public License for more details.\n *\n * You should have received a copy of the GNU Affero General Public License\n * along with this program. If not, see <http://www.gnu.org/licenses/>.\n *\n */\n\nimport moment from '@nextcloud/moment';\nimport { translate as t } from '@nextcloud/l10n';\nimport defaultClient from './DavClient.js';\nimport logger from './logger.js';\nimport { genFileInfo } from '../utils/fileUtils.js';\n\n/**\n * @typedef {object} Collection\n * @property {string} basename - The name of the collection (ex: \"Athens\").\n * @property {string} filename - The filename of the collection (ex: \"/photos/admin/places/Athens\").\n * @property {string} source - The full source of the collection (ex: \"https://nextcloud_server1.test/remote.php/dav//photos/admin/places/Athens\").\n * @property {number} nbItems - The number of item in the collection.\n * @property {number} lastPhoto - The file id for the cover of the collection.\n */\n\n/**\n * @typedef {object} CollectionFile\n * @property {string} fileid - The id of the file.\n * @property {string} basename - The name of the file (ex: \"790-IMG_20180906_085724.jpg\").\n * @property {string} filename - The file name of the file (ex: \"/photos/admin/places/Athens/790-IMG_20180906_085724.jpg\").\n * @property {string} source - The full source of the collection (ex: \"https://nextcloud_server1.test/remote.php/dav//photos/admin/places/Athens/790-IMG_20180906_085724.jpg\").\n * @property {object} metadataPhotosSize - The metadata of the file.\n * @property {number} metadataPhotosSize.width - The width of the file.\n * @property {number} metadataPhotosSize.height - The height of the file.\n */\n\n/** @typedef {Object<string, Collection>} IndexedCollections */\n/** @typedef {Object<string, CollectionFile>} IndexedCollectionFiles */\n\n/**\n * @param {string[]} extraProps - Extra properties to add to the DAV request.\n * @return {string}\n */\nfunction getCollectionDavRequest() {\n  let extraProps = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n  return `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<nc:last-photo />\n\t\t\t\t\t<nc:nbItems />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`;\n}\n\n/**\n * @param {string[]} extraProps - Extra properties to add to the DAV request.\n * @return {string}\n */\nfunction getCollectionFilesDavRequest() {\n  let extraProps = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : [];\n  return `<?xml version=\"1.0\"?>\n\t\t\t<d:propfind xmlns:d=\"DAV:\"\n\t\t\t\txmlns:oc=\"http://owncloud.org/ns\"\n\t\t\t\txmlns:nc=\"http://nextcloud.org/ns\"\n\t\t\t\txmlns:ocs=\"http://open-collaboration-services.org/ns\">\n\t\t\t\t<d:prop>\n\t\t\t\t\t<d:getcontentlength />\n\t\t\t\t\t<d:getcontenttype />\n\t\t\t\t\t<d:getetag />\n\t\t\t\t\t<d:getlastmodified />\n\t\t\t\t\t<d:resourcetype />\n\t\t\t\t\t<nc:metadata-photos-size />\n\t\t\t\t\t<nc:metadata-photos-original_date_time />\n\t\t\t\t\t<nc:metadata-files-live-photo />\n\t\t\t\t\t<nc:has-preview />\n\t\t\t\t\t<nc:hidden />\n\t\t\t\t\t<oc:favorite />\n\t\t\t\t\t<oc:fileid />\n\t\t\t\t\t<oc:permissions />\n\t\t\t\t\t${extraProps.join('')}\n\t\t\t\t</d:prop>\n\t\t\t</d:propfind>`;\n}\n\n/**\n * @param {string} path - Collections' root path.\n * @param {import('webdav').StatOptions} options - Options to forward to the webdav client.\n * @param {string[]} extraProps - Extra properties to add to the DAV request.\n * @param {import('webdav').WebDAVClient} client - The DAV client to use.\n * @return {Promise<Collection|null>}\n */\nexport async function fetchCollection(path, options) {\n  let extraProps = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  let client = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : defaultClient;\n  try {\n    const response = await client.stat(path, {\n      data: getCollectionDavRequest(extraProps),\n      details: true,\n      ...options\n    });\n    logger.debug('[Collections] Fetched a collection: ', {\n      data: response.data\n    });\n    return formatCollection(response.data);\n  } catch (error) {\n    if (error.code === 'ERR_CANCELED') {\n      return null;\n    }\n    throw error;\n  }\n}\n\n/**\n *\n * @param {string} path - Collections' root path.\n * @param {import('webdav').StatOptions} options - Options to forward to the webdav client.\n * @param {string[]} extraProps - Extra properties to add to the DAV request.\n * @param {import('webdav').WebDAVClient} client - The DAV client to use.\n * @return {Promise<Collection[]>}\n */\nexport async function fetchCollections(path, options) {\n  let extraProps = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  let client = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : defaultClient;\n  try {\n    const response = await client.getDirectoryContents(path, {\n      data: getCollectionDavRequest(extraProps),\n      details: true,\n      ...options\n    });\n    logger.debug(`[Collections] Fetched ${response.data.length} collections: `, {\n      data: response.data\n    });\n    return response.data.filter(collection => collection.filename !== path).map(formatCollection);\n  } catch (error) {\n    if (error.code === 'ERR_CANCELED') {\n      return [];\n    }\n    throw error;\n  }\n}\n\n/**\n *\n * @param {object} rawCollection - An collection received from a webdav request.\n * @return {Collection}\n */\nfunction formatCollection(rawCollection) {\n  // Ensure that we have a proper collaborators array.\n  if (rawCollection.props.collaborators === undefined || rawCollection.props.collaborators === '') {\n    rawCollection.props.collaborators = [];\n  } else if (typeof rawCollection.props.collaborators.collaborator === 'object') {\n    if (Array.isArray(rawCollection.props.collaborators.collaborator)) {\n      rawCollection.props.collaborators = rawCollection.props.collaborators.collaborator;\n    } else {\n      rawCollection.props.collaborators = [rawCollection.props.collaborators.collaborator];\n    }\n  }\n\n  // Extract custom props.\n  rawCollection = genFileInfo(rawCollection);\n\n  // Compute date range label.\n  const dateRange = JSON.parse(rawCollection.dateRange?.replace(/&quot;/g, '\"') ?? '{}');\n  if (dateRange.start === null) {\n    dateRange.start = moment().unix();\n    dateRange.end = moment().unix();\n  }\n  const dateRangeFormatted = {\n    startDate: moment.unix(dateRange.start).format('MMMM YYYY'),\n    endDate: moment.unix(dateRange.end).format('MMMM YYYY')\n  };\n  if (dateRangeFormatted.startDate === dateRangeFormatted.endDate) {\n    rawCollection.date = dateRangeFormatted.startDate;\n  } else {\n    rawCollection.date = t('photos', '{startDate} to {endDate}', dateRangeFormatted);\n  }\n  return rawCollection;\n}\n\n/**\n *\n * @param {string} path - Collections' root path.\n * @param {import('webdav').StatOptions} options - Options to forward to the webdav client.\n * @param {string[]} extraProps - Extra properties to add to the DAV request.\n * @param {import('webdav').WebDAVClient} client - The DAV client to use.\n * @return {Promise<CollectionFile[]>}\n */\nexport async function fetchCollectionFiles(path, options) {\n  let extraProps = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : [];\n  let client = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : defaultClient;\n  try {\n    const response = await client.getDirectoryContents(path, {\n      data: getCollectionFilesDavRequest(extraProps),\n      details: true,\n      ...options\n    });\n    const fetchedFiles = response.data.map(file => genFileInfo(file)).filter(file => file.fileid);\n    logger.debug(`[Collections] Fetched ${fetchedFiles.length} new files: `, fetchedFiles);\n    return fetchedFiles;\n  } catch (error) {\n    if (error.code === 'ERR_CANCELED') {\n      return [];\n    }\n    logger.error('Error fetching collection files', {\n      error\n    });\n    console.error(error);\n    throw error;\n  }\n}"],"names":[],"sourceRoot":""}